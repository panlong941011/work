<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
    <meta name="viewport"
          content="maximum-scale=1,minimum-scale=1,user-scalable=no,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <meta name="wap-font-scale" content="no">
    <meta name="imagemode" content="force">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>地址</title>
    <link rel="stylesheet" href="../css/common.css">

	<link rel="stylesheet" href="../css/address.css">
    <script src="../js/hotcss.js"></script>
    <link rel="stylesheet" href="../css/LArea.css">
</head>
<body>
	<div class="address_wrap">
		<div class="ad_header">
			<a href="javascript:;" class="ad_back">
				<span class="icon">&#xe885;</span>
			</a>
			<h2>地址选择</h2>
			<span class="ad_more icon">&#xe602;</span>
		</div>
		<div class="ad_list">
			<ul>
				<li data-id="1">
					<div class="address_item chose_item">
						<div class="address_info flex">
							<span>收货人：刘晓林</span>
							<span>15280217510</span>
						</div>
						<div class="address_detail">收货地址：福建省厦门市湖里区软件园二期观日路28号之二202</div>
						<div class="item_using"></div>
					</div>
					<div class="address_ops flex">
						<div class="address_set">
							<span class="address_set_btn default">已设为默认</span>
						</div>	
						<div class="address_other flex">
							<div class="address_edit">
								<span>编辑</span>
							</div>
							<div class="address_del">
								<span>删除</span>
							</div>
						</div>
					</div>
				</li>

				<li data-id="2">
					<div class="address_item chose_item"  >
						<div class="address_info flex">
							<span>收货人：刘晓林</span>
							<span>15280217510</span>
						</div>
						<div class="address_detail">收货地址：福建省厦门市湖里区软件园二期观日路28号之二202</div>
						<div class="chose_btn">使用</div>
					</div>
					<div class="address_ops flex">
						<div class="address_set" >
							<span class="address_set_btn">设为默认地址</span>
						</div>	
						<div class="address_other flex">
							<div class="address_edit">
								<span>编辑</span>
							</div>
							<div class="address_del">
								<span>删除</span>
							</div>
						</div>
					</div>
				</li>

				<li data-id="3">
					<div class="address_item chose_item"  >
						<div class="address_info flex">
							<span>收货人：刘晓林</span>
							<span>15280217510</span>
						</div>
						<div class="address_detail">收货地址：福建省厦门市湖里区软件园二期观日路28号之二202</div>
						<div class="chose_btn">使用</div>
					</div>
					<div class="address_ops flex">
						<div class="address_set" >
							<span class="address_set_btn">设为默认地址</span>
						</div>	
						<div class="address_other flex">
							<div class="address_edit">
								<span>编辑</span>
							</div>
							<div class="address_del">
								<span>删除</span>
							</div>
						</div>
					</div>
				</li>
		
				<li data-id="4">
					<div class="address_item chose_item" >
						<div class="address_info flex">
							<span>收货人：刘晓林</span>
							<span>15280217510</span>
						</div>
						<div class="address_detail">收货地址：福建省厦门市湖里区软件园二期观日路28号之二202</div>
						<div class="chose_btn">使用</div>
					</div>
					<div class="address_ops flex">
						<div class="address_set" >
							<span class="address_set_btn">设为默认地址</span>
						</div>	
						<div class="address_other flex">
							<div class="address_edit">
								<span>编辑</span>
							</div>
							<div class="address_del">
								<span>删除</span>
							</div>
						</div>
					</div>
				</li>

				<li data-id="5">
					<div class="address_item chose_item" >
						<div class="address_info flex">
							<span>收货人：刘晓林</span>
							<span>15280217510</span>
						</div>
						<div class="address_detail">收货地址：福建省厦门市湖里区软件园二期观日路28号之二202</div>
						<div class="chose_btn">使用</div>
					</div>
					<div class="address_ops flex" >
						<div class="address_set">
							<span class="address_set_btn">设为默认地址</span>
						</div>	
						<div class="address_other flex">
							<div class="address_edit">
								<span>编辑</span>
							</div>
							<div class="address_del">
								<span>删除</span>
							</div>
						</div>
					</div>
				</li>

				<li data-id="6">
					<div class="address_item chose_item">
						<div class="address_info flex">
							<span>收货人：刘晓林</span>
							<span>15280217510</span>
						</div>
						<div class="address_detail">收货地址：福建省厦门市湖里区软件园二期观日路28号之二202</div>
						<div class="chose_btn">使用</div>
					</div>
					<div class="address_ops flex">
						<div class="address_set">
							<span class="address_set_btn">设为默认地址</span>
						</div>	
						<div class="address_other flex">
							<div class="address_edit">
								<span>编辑</span>
							</div>
							<div class="address_del">
								<span>删除</span>
							</div>
						</div>
					</div>
				</li>

				<li data-id="7">
					<div class="address_item chose_item">
						<div class="address_info flex">
							<span>收货人：刘晓林</span>
							<span>15280217510</span>
						</div>
						<div class="address_detail">收货地址：福建省厦门市湖里区软件园二期观日路28号之二202</div>
						<div class="chose_btn">使用</div>
					</div>
					<div class="address_ops flex">
						<div class="address_set">
							<span class="address_set_btn">设为默认地址</span>
						</div>	
						<div class="address_other flex">
							<div class="address_edit">
								<span>编辑</span>
							</div>
							<div class="address_del">
								<span>删除</span>
							</div>
						</div>
					</div>
				</li>
			</ul>
		</div>
		<div class="add_new">添加新地址</div>
	</div>
	<!-- <div class="add_new">添加新地址</div> -->

	<div class="add_mask" style="display: none;">
		<div class="addr_main">
	        <div class="addr_title">添加新收货地址</div>
	        <div class="address_receiver">
	            <input class="addr_name" id="name" placeholder="名字" type="text">
	            <input class="addr_mobile" id="mobile" placeholder="电话" type="tel">
	        </div>
	        <div class="addr_region">
	            <input id="choseArea" class="c_area" type="text" readonly="" name="input_area" value="" placeholder="选择地区" >
	        </div>
	        <div class="addr_address">
	            <textarea id="address_text" placeholder="详细地址（可填写街道、小区、大厦）" class="detail_position"></textarea>
	        </div>
	        <div class="addr_save">保存</div>
	        <div class="addr_close"></div>
	    </div>
	</div>
	
	<div class="selection_bar">
	    <div class="select_name"></div>
	    <div class="select_chose flex">
	        <span class="select_cancel flexOne">取消</span>
	        <span class="select_sure flexOne">确认</span>
	    </div>
	</div>
	<div id="tip"></div>

	<div class="weui-loading_toast" style="display: none;">
	    <div class="weui-mask_transparent"></div> 
	    <div class="weui-toast">
	        <i class="weui-loading weui-icon_toast"></i> 
	    </div>
	</div>

	<div class="mask"></div>

</body>
<script src="../js/fastclick.js"></script>
<script src="../js/zepto.min.js"></script>
<script src="../js/LArea.js"></script>
<script src="../js/LAreaCity.js"></script>
<script src="../js/common.js"></script>
<script src="http://mockjs.com/dist/mock.js"></script>
<script>
    Mock.mock('/address/setdef', { 
    	'status': true,
        'message': '设置成功'
    });
    Mock.mock('/address/del', {
    	'status': true,
        'message': '设置成功'
    });
     Mock.mock('/address/edit', {  
    	'name': '王66',
        'mobile': '15039246832',
        'area': '福建省 厦门市 湖里区',
        'address': '莲前街道'
    });
 	Mock.mock('/address/new', { 
    	'name': '王66',
        'mobile': '15039246832',
        'area': '福建省 厦门市 湖里区',
        'address': '莲前街道'
    });
</script>
<script>
	$(function() {
		 FastClick.attach(document.body);

		 var areaType = '' //地址处理类型
		//设置默认地址
		$('.address_set').on('click',function() {
			var id = $(this).parents('li').data('id');
			$('.address_set_btn').removeClass('default');
			$(this).children('.address_set_btn').addClass('default');

			$.post('/address/setdef', //post 看效果 实际用get,具体看接口需要特别注意
				{
					id:id
				},
				function(res) {
					console.log(res);
				},'json')
		})
		//新建地址
		$('.add_new').on('click',function() {
			areaType = 'new';
			$('.add_mask').show();
			$('body,html').css('overflow','hidden');
			$('.add_mask').height( $(window).height() );

			$('body').on('touchmove',function(event) {
				event.preventDefault()
			})
		})
		$('.addr_close').on('click',function(event) {
			 event.stopPropagation();
			 $('.add_mask').hide();

			 $('body,html').css('overflow','');
			 $("body").unbind("touchmove");
		})
		/*$('.add_mask').on('click',function() {
			$(this).hide();
		})
		$('.addr_main').on('click',function(event) {
			 event.stopPropagation();
		})*/

		//编辑地址
		var  editId = '';
		$('.address_edit').on('click',function() {
			areaType = 'edit'
			editId = $(this).parents('li').data('id');

			$.ajax({
                    url: '/address/edit',
                    dataType: 'json',
                    data: { addressid: editId },
                    type: 'post',
                    success: function(data, status, xhr) {
                        console.log(data);

                        $('#name').val(data.name);
                        $('#mobile').val(data.mobile);
                        $('#choseArea').val(data.area);
                        $('#address_text').val(data.address);
                        $('.add_mask').show();
                        listenerVal();
                    }
                });
              
		})

		var delId = '';
		//删除地址
		$('.address_del').on('click',function() {
			delId = $(this).parents('li').data('id');
			$('.mask').show();
			shoperm.selection('确定要删除该地址么',delAddress,cancelDel);
		})
		//先确定 再取消
		function delAddress() {
			$('.mask').hide();
			$.post('/address/del',
				{
					id: delId
				},function(res) {
					console.log(res);
					location.reload();

				},'json')
		}
		function cancelDel() {
			$('.mask').hide();
		}
		//保存地址
		$('.addr_save').on('click',function() {
			var sName = $('.addr_name').val(),
				sPhone = $('.addr_mobile').val();
				sArea = $('.c_area').val();
				sPosition = $('.detail_position').val();
				validate = /^1\d{10}$/,
				areaData = {
					name: sName,
					mobile: sPhone,
					area: sArea,
					address: sPosition
				};
			if( sName == '') {
				shoperm.showTip("收货人名字不能为空");
				return;
			}
			if(sName.length > 8) {
				shoperm.showTip("名字不能超过8个字");
				$('.addr_name').addClass('input_error');
				return;
			}
			if(sPhone == '') {
				shoperm.showTip("收货人电话不能为空");
				return;
			}
			if( !validate.test(sPhone) ) {
				$('.addr_mobile').addClass('input_error');
				shoperm.showTip("请输入正确的手机号");
				return;
			}
			if( sArea == '' ) {
				shoperm.showTip("请选择地区");
				return;
			}
			if( sPosition == '') {
				shoperm.showTip("详细地址不能为空");
				return;
			} 
			if(sPosition.length > 60) {
				$('.detail_position').addClass('input_error');
				shoperm.showTip("地址不能超过60个字");
				return;
			}

			if( areaType == 'new') {
				
				$.post('/address/new',areaData,
					function(res) {
						console.log(res);
						location.href = "http://m.shop.myerm.cn/shop0/home";
				},'json')

			}
			if( areaType == 'edit') {
				areaData.addressid = editId;
				$.post('/address/edit',areaData,
					function(res) {
						console.log(res);
						location.href = "http://m.shop.myerm.cn/shop0/home";
				},'json')

			}
			
		})

        //信息填写完全时显示保存按钮颜色
		$('.addr_name,.addr_mobile,.detail_position').on('input',function() {
			listenerVal();
		});
		$('.addr_name,.addr_mobile,.detail_position').on('click',function() {
			$(this).removeClass('input_error');
		});

		//使用地址
		$('.address_item').on('click',function() {
			var id = $(this).parent().data('id'); //选择的id
			console.log(id);
			location.href = "http://m.shop.myerm.cn/shop0/home" //模拟跳转
		})

	})

	//保存按钮是否显示红色
	function listenerVal() {
		var name = $('.addr_name').val(),
			phone = $('.addr_mobile').val(),
			area = $('.c_area').val(),
			position = $('.detail_position').val();
		if( name !== ''&& phone !== ''&& area !== ''&& position !== '' ) {
			$('.addr_save').addClass('active');
		} else {
			$('.addr_save').removeClass('active');
		}
	}
</script>
<script>
	var area = new LArea();
    area.init({
        'trigger': '#choseArea',//触发选择控件的文本框，同时选择完毕后name属性输出到该位置
        'valueTo':'#value1',//选择完毕后id属性输出到该位置
        'keys':{id:'id',name:'name'},//绑定数据源相关字段 id对应valueTo的value属性输出 name对应trigger的value属性输出
        'type':1,//数据源类型
        'data':LAreaData,//数据源
        'getVal':function(selectedVal){

            var sProvince = selectedVal.province;
            var sCity = '';
           // console.log(selectedVal);
            if (sProvince == "北京市" || sProvince == "上海市" || sProvince == "天津市" || sProvince == "重庆市") {
                sCity = sProvince;
            } else {
                sCity = selectedVal.city;
            }
            //setFreight(ProductID, sProvince, sCity);
            listenerVal();
        },
        'cancelChose':function() {
            listenerVal();
        }
    });

</script>
</html>